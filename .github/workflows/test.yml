name: Comprehensive Testing Suite

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run tests daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  # ============================================================================
  # Quick Validation (Fast tests on multiple Python versions)
  # ============================================================================
  quick-validation:
    name: Quick Validation (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.8', '3.9', '3.10', '3.11']
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
      
      - name: Cache pip packages
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov
          pip install torch --index-url https://download.pytorch.org/whl/cpu
          pip install numpy
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      
      - name: Run fast unit tests
        run: |
          pytest tests/test_model.py tests/test_tokenizer.py -v --tb=short -m "not slow"
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: test-results-${{ matrix.python-version }}
          path: test-results/

  # ============================================================================
  # Full Test Suite (Comprehensive tests on primary Python version)
  # ============================================================================
  full-test-suite:
    name: Full Test Suite
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Cache pip packages
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-full-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-full-
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov pytest-timeout pytest-xdist
          pip install torch --index-url https://download.pytorch.org/whl/cpu
          pip install numpy tiktoken
          pip install datasets transformers
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      
      - name: Run model tests
        run: |
          pytest tests/test_model.py -v --tb=short --cov=model --cov-report=xml:coverage-model.xml
      
      - name: Run tokenizer tests
        run: |
          pytest tests/test_tokenizer.py -v --tb=short --cov=tokenizer --cov-report=xml:coverage-tokenizer.xml
      
      - name: Run trainer tests
        run: |
          pytest tests/test_trainer.py -v --tb=short --cov=trainer --cov-report=xml:coverage-trainer.xml
      
      - name: Run integration tests
        run: |
          pytest tests/test_integration.py -v --tb=short
      
      - name: Run performance tests
        run: |
          pytest tests/test_performance.py -v --tb=short
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage-*.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  # ============================================================================
  # GPU Tests (If GPU runner available)
  # ============================================================================
  gpu-tests:
    name: GPU Tests
    runs-on: ubuntu-latest
    # Uncomment below if you have GPU runners
    # runs-on: [self-hosted, gpu]
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest
          # pip install torch --index-url https://download.pytorch.org/whl/cu118
          pip install torch --index-url https://download.pytorch.org/whl/cpu
      
      - name: Check GPU availability
        run: |
          python -c "import torch; print(f'CUDA available: {torch.cuda.is_available()}')"
      
      - name: Run GPU tests (mocked)
        run: |
          echo "GPU tests skipped - no GPU runner configured"

  # ============================================================================
  # Code Quality Checks
  # ============================================================================
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install linting tools
        run: |
          python -m pip install --upgrade pip
          pip install flake8 pylint black isort mypy
      
      - name: Check formatting with black
        run: |
          black --check . || echo "Black formatting check failed (non-blocking)"
        continue-on-error: true
      
      - name: Check import sorting with isort
        run: |
          isort --check-only . || echo "Isort check failed (non-blocking)"
        continue-on-error: true
      
      - name: Lint with flake8
        run: |
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics || echo "Critical flake8 errors found"
          flake8 . --count --exit-zero --max-complexity=15 --max-line-length=120 --statistics
        continue-on-error: true

  # ============================================================================
  # Documentation Tests
  # ============================================================================
  docs-tests:
    name: Documentation Tests
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-doctest
          pip install torch --index-url https://download.pytorch.org/whl/cpu
      
      - name: Test docstrings
        run: |
          pytest --doctest-modules model.py tokenizer.py || echo "Doctest warnings (non-blocking)"
        continue-on-error: true

  # ============================================================================
  # Performance Regression Tests
  # ============================================================================
  performance-regression:
    name: Performance Regression
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Fetch all history for comparison
      
      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-benchmark
          pip install torch --index-url https://download.pytorch.org/whl/cpu
      
      - name: Run performance benchmarks
        run: |
          pytest tests/test_performance.py --benchmark-only || echo "Benchmark tests (informational)"
        continue-on-error: true
      
      - name: Store benchmark result
        uses: benchmark-action/github-action-benchmark@v1
        if: github.event_name != 'pull_request'
        with:
          tool: 'pytest'
          output-file-path: benchmark_results.json
          github-token: ${{ secrets.GITHUB_TOKEN }}
          auto-push: false

  # ============================================================================
  # Summary Report
  # ============================================================================
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [quick-validation, full-test-suite, code-quality]
    if: always()
    
    steps:
      - name: Check test results
        run: |
          echo "Quick Validation: ${{ needs.quick-validation.result }}"
          echo "Full Test Suite: ${{ needs.full-test-suite.result }}"
          echo "Code Quality: ${{ needs.code-quality.result }}"
      
      - name: Post summary
        run: |
          if [ "${{ needs.full-test-suite.result }}" == "success" ]; then
            echo "✅ All critical tests passed!"
          else
            echo "❌ Some tests failed. Please review the logs."
            exit 1
          fi
